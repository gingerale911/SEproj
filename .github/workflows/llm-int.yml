name: Comment security issues from git diff on PR to main

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  add-comment:
    name: Analyze git diff for security vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Analyze git diff with Gemini 2.5 Flash Lite
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            const https = require('https');

            const pr = context.payload.pull_request;
            if (!pr) {
              console.log('No pull_request found in context; skipping.');
              return;
            }

            const base = pr.base.sha;
            const head = pr.head.sha;

            let diff = '';
            try {
              diff = execSync(`git diff --unified=1 ${base} ${head}`, { encoding: 'utf-8', maxBuffer: 1024 * 1000 });
            } catch (error) {
              diff = `Error generating diff: ${error.message}`;
            }

            const prompt = `You are a devsecops code reviewer. Analyze the following git diff for any security vulnerabilities such as exposed API keys, SQL injection risks, or other common security flaws. If any issues are found, explain them concisely like a robot Markdown format, listing each issue with the format: ### ⚠️ [Vulnerability Name]\\n**Risk Level:** [LOW | MEDIUM | HIGH | CRITICAL]\\n**Description:** [Brief but clear description]\\n**Fix:** [One-sentence recommended fix]. If none are found, respond with "Clean code – no security issues detected."\n\n${diff}`;

            const apiKey = 'AIzaSyDW7D_GLQWagUGZ3E2FrKRoPw9PKaGP6bM';

            const requestData = JSON.stringify({
              contents: [{ parts: [{ text: prompt }] }],
              generationConfig: { temperature: 0.2 }
            });

            const options = {
              hostname: 'generativelanguage.googleapis.com',
              path: `/v1beta/models/gemini-2.5-flash-lite:generateContent?key=${apiKey}`,
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Content-Length': Buffer.byteLength(requestData)
              }
            };

            const response = await new Promise((resolve, reject) => {
              const req = https.request(options, res => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => resolve(JSON.parse(data)));
              });
              req.on('error', reject);
              req.write(requestData);
              req.end();
            });

            const reply = response?.candidates?.[0]?.content?.parts?.[0]?.text || 'No response from Gemini';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `Review by the Dev Sec Model:\n\n${reply}`
            });
