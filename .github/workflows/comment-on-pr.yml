
name: Comment "hi" on PR to main

on:
  pull_request_target:
    types: [opened, reopened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  issues: write
  contents: read

jobs:
  add-comment:
    name: Add comment to PR
    runs-on: ubuntu-latest
    steps:
        - name: Check out repository
          uses: actions/checkout@v4
      - name: Get git diff
        id: diff
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git diff ${{ github.event.pull_request.base.sha }} ${{ github.event.pull_request.head.sha }} > diff.txt
          echo "::set-output name=diff::$(cat diff.txt | head -c 5000)"

      - name: Comment with git diff
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (!pr) {
              console.log('No pull_request found in context; skipping.');
              return;
            }
            const diff = process.env.DIFF || "No diff found.";
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `Git diff of changes (truncated to 5000 chars):\n\n${diff}`
            });
        env:
          DIFF: ${{ steps.diff.outputs.diff }}
